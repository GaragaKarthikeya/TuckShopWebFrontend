<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üë®‚Äçüç≥ Kitchen Display System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <style>
        body { background-color: #2c3e50; color: white; }
        .order-card { 
            color: black; 
            border-left: 10px solid #ccc;
            transition: all 0.3s ease;
        }
        /* State Colors */
        .status-PENDING { border-left-color: #ffc107; background: #fff3cd; }
        .status-ACCEPTED { border-left-color: #0d6efd; background: #cff4fc; }
        .status-READY { border-left-color: #198754; background: #d1e7dd; }
        
        .status-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .connected { background-color: #28a745; box-shadow: 0 0 10px #28a745; }
        .disconnected { background-color: #dc3545; }
    </style>
</head>
<body>
    <div class="container-fluid p-4">
        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3 border-secondary">
            <h2 class="fw-bold">üë®‚Äçüç≥ Kitchen Live Feed</h2>
            <div>
                <span id="status-dot" class="status-dot disconnected"></span>
                <span id="status-text" class="text-muted small">Connecting...</span>
            </div>
        </div>

        <div id="orders-container" class="row">
            <div class="col-12 text-center text-muted mt-5 opacity-50" id="empty-state">
                <h1>üçΩÔ∏è</h1>
                <h3>Waiting for orders...</h3>
            </div>
        </div>
    </div>

    <script>
        // ‚úÖ YOUR CLOUD API URL
        const API_URL = "https://tuckshop-api-karthikeya.azurewebsites.net/api";

        // 1. Connect to SignalR
        const connection = new signalR.HubConnectionBuilder()
            .withUrl(API_URL) 
            .withAutomaticReconnect()
            .configureLogging(signalR.LogLevel.Information)
            .build();

        async function start() {
            try {
                await connection.start();
                updateStatusUI(true);
            } catch (err) {
                console.error(err);
                updateStatusUI(false);
                setTimeout(start, 5000);
            }
        }

        function updateStatusUI(isConnected) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            if (isConnected) {
                dot.className = "status-dot connected";
                text.innerText = "Live";
            } else {
                dot.className = "status-dot disconnected";
                text.innerText = "Offline";
            }
        }

        // 2. Button Logic (The State Machine)
        function getButtons(order) {
            const { id, studentId } = order;
            if (order.status === 'PENDING') {
                return `
                    <div class="row g-2">
                        <div class="col-6"><button class="btn btn-outline-danger w-100" onclick="updateOrder('${id}', '${studentId}', 'REJECTED')">Reject</button></div>
                        <div class="col-6"><button class="btn btn-primary w-100" onclick="updateOrder('${id}', '${studentId}', 'ACCEPTED')">Accept</button></div>
                    </div>`;
            } else if (order.status === 'ACCEPTED') {
                return `<button class="btn btn-warning w-100 fw-bold" onclick="updateOrder('${id}', '${studentId}', 'READY')">‚ö° Mark Ready</button>`;
            } else if (order.status === 'READY') {
                return `<button class="btn btn-success w-100 fw-bold" onclick="updateOrder('${id}', '${studentId}', 'COMPLETED')">üí∞ Paid & Delivered</button>`;
            }
            return '';
        }

        // 3. API Call
        async function updateOrder(orderId, studentId, newStatus) {
            try {
                await fetch(`${API_URL}/updateOrder`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId, studentId, newStatus })
                });
            } catch (e) {
                alert("Network Error: Could not update order");
            }
        }

        // 4. Render Logic (Handles New AND Updated orders)
        function renderCard(order) {
            // Remove existing card if it's there (to update it)
            const existing = document.getElementById(`card-${order.id}`);
            if (existing) existing.remove();

            // If Completed/Rejected, we are done with it
            if (order.status === 'COMPLETED' || order.status === 'REJECTED') return;

            document.getElementById('empty-state').style.display = 'none';

            const container = document.getElementById('orders-container');
            const itemsHtml = order.items.map(i => `<li><b>${i.qty}x</b> ${i.name}</li>`).join('');
            const time = new Date(order.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const html = `
                <div class="col-xl-3 col-lg-4 col-md-6 mb-4" id="card-${order.id}">
                    <div class="card order-card shadow status-${order.status}">
                        <div class="card-header d-flex justify-content-between bg-transparent border-bottom border-dark-subtle">
                            <strong>#${order.id}</strong>
                            <small>${time}</small>
                        </div>
                        <div class="card-body">
                            <h6 class="text-muted small">User: ${order.studentId}</h6>
                            <ul class="list-unstyled mb-3">${itemsHtml}</ul>
                            <div class="mt-2">${getButtons(order)}</div>
                        </div>
                    </div>
                </div>
            `;
            // Add to top
            container.insertAdjacentHTML('afterbegin', html);
        }

        // Listeners
        connection.on("newOrder", renderCard);
        connection.on("orderUpdated", renderCard);

        start();
    </script>
</body>
</html>