<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Food - IIITB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
</head>
<body class="bg-light">

    <nav class="navbar navbar-dark bg-primary sticky-top shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">üçî IIITB Tuck Shop</a>
            <button class="btn btn-warning position-relative" onclick="showCart()">
                üõí <span id="cart-count" class="badge bg-danger rounded-pill">0</span>
            </button>
        </div>
    </nav>

    <div class="container mt-5">
        <div id="status-bar" class="alert alert-info text-center" style="display:none;">
            üì° Connecting to Kitchen...
        </div>

        <h3 class="mb-4">üìã Today's Menu</h3>
        <div id="menu-container" class="row g-4">
            <div class="text-center mt-5"><div class="spinner-border text-primary"></div></div>
        </div>
    </div>

    <script>
        // ‚úÖ YOUR CLOUD API URL
        const API_URL = "https://tuckshop-api-karthikeya.azurewebsites.net/api";
        // Generate a random student ID for this session
        const STUDENT_ID = "student_" + Math.floor(Math.random() * 9000 + 1000);
        let cart = [];

        // 1. Initialize SignalR (For Notifications)
        const connection = new signalR.HubConnectionBuilder()
            .withUrl(API_URL)
            .withAutomaticReconnect()
            .build();

        async function initApp() {
            // Load Menu
            try {
                const res = await fetch(`${API_URL}/getMenu`);
                const menu = await res.json();
                renderMenu(menu);
            } catch (e) {
                document.getElementById('menu-container').innerHTML = `<div class="alert alert-danger">Kitchen Offline</div>`;
            }

            // Connect to Real-time Updates
            try {
                await connection.start();
                console.log("Connected to Kitchen Updates");
            } catch(e) { console.error("SignalR Failed", e); }
        }

        // 2. Listen for "Your Food is Ready"
        connection.on("orderUpdated", (order) => {
            // Only alert if it's MY order
            if (order.studentId === STUDENT_ID) {
                if (order.status === 'ACCEPTED') {
                    Swal.fire({
                        toast: true, position: 'top-end', icon: 'info', 
                        title: 'Order Accepted!', text: 'The cook is preparing your food.', timer: 3000
                    });
                } 
                else if (order.status === 'READY') {
                    // Play notification sound (optional)
                    // new Audio('ping.mp3').play().catch(()=>{});
                    Swal.fire({
                        title: 'üçî FOOD READY!',
                        text: `Order #${order.id} is ready at the counter!`,
                        icon: 'success',
                        confirmButtonText: 'On my way!',
                        backdrop: `rgba(0,123,0,0.4)`
                    });
                }
            }
        });

        // 3. Render Menu
        function renderMenu(menu) {
            const container = document.getElementById('menu-container');
            if(menu.length === 0) { container.innerHTML = "No items."; return; }

            container.innerHTML = menu.map(item => `
                <div class="col-md-4 col-6">
                    <div class="card h-100 shadow-sm">
                        <div style="height:150px; background:#eee; display:flex; align-items:center; justify-content:center;">
                            <img src="${item.image || ''}" style="max-height:100%; max-width:100%" onerror="this.style.display='none'">
                            <span class="text-muted" style="${item.image ? 'display:none' : ''}">üçî</span>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <h5 class="card-title">${item.name}</h5>
                                <span class="badge bg-success">‚Çπ${item.price}</span>
                            </div>
                            <button class="btn btn-outline-primary w-100 mt-2" onclick='addToCart(${JSON.stringify(item)})'>Add +</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 4. Cart Logic
        function addToCart(item) {
            cart.push(item);
            document.getElementById('cart-count').innerText = cart.length;
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Added!', showConfirmButton: false, timer: 1000 });
        }

        async function showCart() {
            if (cart.length === 0) return Swal.fire('Cart Empty');
            const total = cart.reduce((s, i) => s + i.price, 0);
            
            const result = await Swal.fire({
                title: 'Place Order?',
                html: `Total: <b>‚Çπ${total}</b><br>Items: ${cart.length}`,
                showCancelButton: true,
                confirmButtonText: 'Place Order'
            });

            if (result.isConfirmed) placeOrder(total);
        }

        async function placeOrder(total) {
            Swal.showLoading();
            const payload = {
                studentId: STUDENT_ID,
                totalAmount: total,
                items: cart.map(i => ({ name: i.name, qty: 1, price: i.price }))
            };

            try {
                await fetch(`${API_URL}/createOrder`, {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                cart = [];
                document.getElementById('cart-count').innerText = 0;
                Swal.fire('Sent!', `Order sent. Your ID: ${STUDENT_ID}`, 'success');
            } catch (e) {
                Swal.fire('Error', 'Failed to send order', 'error');
            }
        }

        // Start
        initApp();
    </script>
</body>
</html>